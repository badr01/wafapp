'use strict';
var loading = false;
var myApp = angular.module('mgcrea.WafApp', [
    'ngResource',
    'ngTagsInput',
    'ui.bootstrap',
    'smart-table',
    'ngRoute',
    'frapontillo.bootstrap-switch',
    'angularHighlightTextarea'
  ]).constant('version', 'v0.1.0').config([
    '$locationProvider',
    '$routeProvider',
    '$httpProvider',
    function ($locationProvider, $routeProvider, $httpProvider) {
      //Enable cross domain calls
      $httpProvider.defaults.useXDomain = true;
      delete $httpProvider.defaults.headers.common['X-Requested-With'];
      $locationProvider.html5Mode(false);
      $routeProvider.when('/', { templateUrl: 'views/home.html' }).when('/etat', { templateUrl: '../views/etat.html' }).when('/manage', { templateUrl: '../views/manage.html' }).when('/journalisation', { templateUrl: '../views/journalisation.html' }).when('/journalisationb', { templateUrl: '../views/journalisationb.html' }).when('/settings', { templateUrl: '../views/settings.html' }).when('/update', { templateUrl: '../views/update.html' }).otherwise({ redirectTo: '/' });
    }
  ]);
'use strict';
//header page controlller
myApp.controller('MainCtrl', [
  '$scope',
  '$location',
  'version',
  function ($scope, $location, version) {
    $scope.$path = $location.path.bind($location);
    $scope.version = version;
  }
]);
//Status controller
myApp.controller('EtatCtrl', [
  '$scope',
  'Status',
  'alertService',
  function ($scope, Status, alertService) {
    $scope.status = {
      output: '',
      nginxStatus: false,
      haproxyStatus: false
    };
    $scope.execute = function (cmd) {
      Status.query({ cmd: cmd }, function (data) {
        $scope.status = data;
        alertService.addAlert('success', data.output);
      }, function (data) {
        alertService.addAlert('danger', data.output);
      });
    };
    var res = Status.query({ cmd: 'NGINX_STATUS' }, function (data) {
        $scope.status = data;
        alertService.addAlert('success', data.output);
      }, function (data) {
        alertService.addAlert('danger', data.output);
      });
  }
]);
myApp.service('alertService', [
  '$timeout',
  function ($timeout) {
    var data = [];
    this.alerts = function () {
      return data;
    };
    this.addAlert = function (type, msg) {
      data.push({
        type: type,
        msg: msg
      });
      $timeout(function () {
        data.splice(data.indexOf({
          type: type,
          msg: msg
        }), 1);
      }, 3000);
    };
    this.deleteAlert = function (index) {
      data.splice(index, 1);
    };
  }
]);
myApp.controller('alertCtrl', [
  '$scope',
  'alertService',
  function ($scope, alertService) {
    $scope.alerts = alertService.alerts();
    $scope.closeAlert = function (index) {
      alertService.deleteAlert(index);
    };
  }
]);
'use strict';
/*Pagination controller*/
myApp.controller('paginationCtrl', [
  '$scope',
  'Access',
  function ($scope, Access) {
    Access.query(function (data) {
      data.forEach(function (elt, ix, arr) {
        arr[ix].time = elt.time.$date;
      });
      $scope.rowCollection = angular.fromJson(data);
      window.aa = angular.fromJson(data);
    });
    $scope.displayCollection = [].concat($scope.rowCollection);
    $scope.itemsByPage = 15;
    $scope.predicates = [
      {
        key: 'Filter by Host',
        'value': 'host'
      },
      {
        key: 'Filter by User_IP',
        'value': 'client_ip'
      },
      {
        key: 'Filter by User',
        'value': 'client'
      },
      {
        key: 'Filter by URI_Path',
        'value': 'path'
      },
      {
        key: 'Filter by Method',
        'value': 'method'
      },
      {
        key: 'Filter by HTTP_Status',
        'value': 'code'
      },
      {
        key: 'Filter by Referer',
        'value': 'referer'
      },
      {
        key: 'Filter by Bytes',
        'value': 'size'
      },
      {
        key: 'Filter by X_Forwarded_For',
        'value': 'x_forwarded_for'
      },
      {
        key: 'Filter by User_Agent',
        'value': 'user_agent'
      }
    ];
    $scope.selectedPredicate = $scope.predicates[0].value;
  }
]);
/*date picker controller logic*/
myApp.controller('DatepickerCtrl', [
  '$scope',
  'Access',
  function ($scope, Access) {
    $scope.today = function (dt) {
      $scope[dt] = new Date();
    };
    $scope.today();
    $scope.clear = function (dt) {
      $scope[dt] = null;
    };
    $scope.getLog = function () {
      Access.query({
        from: $scope.dtFrom,
        to: $scope.dtTo
      }, function (data) {
        data.forEach(function (elt, ix, arr) {
          arr[ix].time = elt.time.$date;
        });
        $scope.$parent.rowCollection = angular.fromJson(data);
      });
    };
    $scope.open = function ($event, opened) {
      $event.preventDefault();
      $event.stopPropagation();
      $scope[opened] = opened;
    };
    $scope.dateOptions = {
      formatYear: 'yy',
      startingDay: 1
    };
    $scope.format = 'dd.MM.yyyy HH:mm:ss';
  }
]);
'use strict';
/*Pagination controller*/
myApp.controller('paginationBCtrl', [
  '$scope',
  'Error',
  '$modal',
  function ($scope, Error, $modal) {
    Error.query(function (data) {
      data.forEach(function (elt, ix, arr) {
        arr[ix].time = elt._id.time.$date;
        arr[ix].host = elt._id.host;
        arr[ix].client_ip = elt._id.client_ip;
        arr[ix].path = elt._id.path;
      });
      $scope.rowCollection = angular.fromJson(data);
      window.aa = angular.fromJson(data);
    });
    $scope.displayCollection = [].concat($scope.rowCollection);
    $scope.itemsByPage = 15;
    $scope.predicates = [
      {
        key: 'Filter by Host',
        'value': 'host'
      },
      {
        key: 'Filter by User IP',
        'value': 'client ip'
      },
      {
        key: 'Filter by URI Path',
        'value': 'path'
      }
    ];
    $scope.selectedPredicate = $scope.predicates[0].value;
    $scope.isCollapsed = true;
    // Modal: called by "supprimer site"
    $scope.openDialog = function (rules, size) {
      var $modalInstance = $modal.open({
          templateUrl: 'rulesModalDialog',
          controller: 'ShowDialogCtrl',
          size: size,
          resolve: {
            rules: function () {
              return rules;
            }
          }
        });
    };
  }
]);
//show rules modal controller
myApp.controller('ShowDialogCtrl', [
  '$scope',
  '$modalInstance',
  'rules',
  function ($scope, $modalInstance, rules) {
    $scope.rules = rules;
    //dismiss and quit the modal dialog;
    $scope.cancel = function () {
      $modalInstance.dismiss('cancel');
    };
  }
]);
//experimental feature : filter highlighting match zone in requests
myApp.filter('highlight', [
  '$sce',
  function ($sce) {
    return function (text, phrase) {
      if (phrase)
        text = text.replace(new RegExp('(' + phrase + '=[^ ]*)', 'gi'), '<span class="badge bg-primary">$1</span>');
      return $sce.trustAsHtml(text);
    };
  }
]);
/*date picker controller logic*/
myApp.controller('DatepickerBCtrl', [
  '$scope',
  'Error',
  function ($scope, Error) {
    $scope.today = function (dt) {
      $scope[dt] = new Date();
    };
    $scope.today();
    $scope.clear = function (dt) {
      $scope[dt] = null;
    };
    $scope.getLog = function () {
      Error.query({
        from: $scope.dtFrom,
        to: $scope.dtTo
      }, function (data) {
        data.forEach(function (elt, ix, arr) {
          arr[ix].time = elt._id.time.$date;
          arr[ix].host = elt._id.host;
          arr[ix].client_ip = elt._id.client_ip;
          arr[ix].path = elt._id.path;
        });
        $scope.$parent.rowCollection = angular.fromJson(data);
      });
    };
    $scope.open = function ($event, opened) {
      $event.preventDefault();
      $event.stopPropagation();
      $scope[opened] = opened;
    };
    $scope.dateOptions = {
      formatYear: 'yy',
      startingDay: 1
    };
    $scope.format = 'dd.MM.yyyy HH:mm:ss';
  }
]);
'use strict';
//site list controller
myApp.controller('ListCtrl', [
  '$scope',
  '$modal',
  'Site',
  '$timeout',
  function ($scope, $modal, Site, $timeout) {
    $scope.update = function () {
      Site.query(function (data) {
        $scope.sites = data;
      });
    };
    $scope.update();
    $scope.removeRecord = function (nomDomaine) {
      $scope.openDialog(nomDomaine);
    };
    // Modal: called by "supprimer site"
    $scope.openDialog = function (domain) {
      var modalInstance = $modal.open({
          templateUrl: 'myModalDialog',
          controller: 'ModalDialogCtrl'
        });
      modalInstance.result.then(function () {
        Site.delete({ domain: domain });
        $timeout(function () {
          $scope.update();
        }, 200);
      });
    };
    // Modal: called by "Afficher"
    $scope.openWL = function (site) {
      var modalInstance = $modal.open({
          templateUrl: 'wl_modal',
          controller: 'WlModalCtrl',
          size: 'lg',
          resolve: {
            site: function () {
              return site;
            }
          }
        });
    };
    // Modal: called by "modifier site " and Add new site
    $scope.open = function (domain) {
      var modalInstance = $modal.open({
          templateUrl: 'add_site_modal',
          controller: 'ModalCtrl',
          resolve: {
            domain: function () {
              return domain;
            },
            modif: function () {
              return true;
            }
          }
        });
      //saving modifications after dialog dismissal
      modalInstance.result.then(function () {
        $timeout(function () {
          $scope.update();
        }, 1000);
      });
    };
  }
]);
//controls the removal confirmation modal dialog
myApp.controller('ModalDialogCtrl', [
  '$scope',
  '$modalInstance',
  function ($scope, $modalInstance) {
    $scope.cancel = function () {
      $modalInstance.dismiss('cancel');
    };
    $scope.ok = function () {
      $modalInstance.close();
    };
  }
]);
// modal that controls "Ajouter site" and "enregistrer site"
myApp.controller('ModalCtrl', [
  '$scope',
  '$modalInstance',
  'domain',
  'Site',
  'modif',
  function ($scope, $modalInstance, domain, Site, modif) {
    if (typeof domain !== 'undefined') {
      Site.get({ domain: domain }, function (data) {
        $scope.site = data;
      });
      $scope.modif = modif;
    } else {
      $scope.modif = false;
    }
    //cancel and quit the modal dialog;
    $scope.cancel = function () {
      $modalInstance.dismiss('cancel');
    };
    // Add new domain
    $scope.add = function () {
      Site.save($scope.site);
      $modalInstance.close();
    };
    // Save edited domain.
    $scope.save = function () {
      Site.save($scope.site);
      $modalInstance.close();
    };
  }
]);
//whitelidst modal controller
myApp.controller('WlModalCtrl', [
  '$scope',
  '$modalInstance',
  'site',
  'Site',
  '$http',
  function ($scope, $modalInstance, site, Site, $http) {
    //dismiss and quit the modal dialog;
    $scope.cancel = function () {
      $modalInstance.dismiss('cancel');
    };
    $scope.validate = function () {
      var rx = /BasicRule wl:[0-9]{1,4}(,[0-9]{1,4})*\s("mz:(\$?URL(_X)?(:[^|;]*)?)?(\|?\$?(ARGS|ARGS_VAR:[^|;]*|ARGS_VAR_X:[^|;]*|HEADERS|HEADERS_VAR:[^|;]*|HEADERS_VAR_X:[^|;]|BODY|BODY_VAR:[^|;]*|BODY_VAR_X:[^|;]|URL|URL:[^|;]*|URL_X:[^|;]*)(\|NAME)?)?")?;/;
      var wl = $scope.current == undefined ? '' : $scope.current;
      var wls = $scope.textarea == undefined ? [''] : $scope.textarea.split('\n');
      if (rx.test(wl) && $scope.site['wlList'].indexOf(wl) == -1) {
        $scope.site['wlList'].push(wl);
      }
      ;
      wls.forEach(function (elt, ix, array) {
        if (rx.test(elt) && $scope.site['wlList'].indexOf(elt) == -1) {
          $scope.site['wlList'].push(elt);
        }
      });
      window.tt = wls;
    };
    $scope.site = angular.copy(site);
    $scope.wls = $scope.site['wlList'];
    /*EXPERIMENTAL FEATURE  $scope.modifyWL= function (ix) {
   $scope.current=$scope.wls[ix];
   }*/
    $scope.removeWL = function (ix) {
      $scope.wls.splice(ix, 1);
    };
    $scope.ok = function () {
      Site.save($scope.site);
    };
    $scope.ids = [];
    $scope.zones = [
      {
        value: 'all',
        key: 'Toute les zones'
      },
      {
        value: 'ARGS',
        key: 'Args'
      },
      {
        value: '$ARGS_VAR',
        key: 'Variables args'
      },
      {
        value: '$ARGS_VAR_X',
        key: 'Variables args regex'
      },
      {
        value: 'HEADERS',
        key: 'Headers'
      },
      {
        value: '$HEADERS_VAR',
        key: 'Variables header'
      },
      {
        value: '$HEADERS_VAR_X',
        key: 'Variables header regexp'
      },
      {
        value: 'BODY',
        key: 'Body'
      },
      {
        value: '$BODY_VAR',
        key: 'Variables body'
      },
      {
        value: '$BODY_VAR_X',
        key: 'Variables body regexp'
      },
      {
        value: '$URL',
        key: 'URL'
      },
      {
        value: '$URL_X',
        key: 'URL regexp'
      },
      {
        value: 'FILE_EXT',
        key: 'Extension du fichier '
      }
    ];
    $scope.urls = [
      {
        value: 'all',
        key: 'Tout les URLs'
      },
      {
        value: '$URL',
        key: 'URL'
      },
      {
        value: '$URL_X',
        key: 'URL regexp'
      }
    ];
    $scope.urlFltr = $scope.urls[0];
    $scope.zone = $scope.zones[0];
    $scope.dsblurl = true;
    $scope.dsblzone = true;
    $scope.isDsbl = function () {
      if ($scope.urlFltr.value == 'all') {
        $scope.dsblurl = true;
        $scope.urlContent = '';
      } else {
        $scope.dsblurl = false;
      }
      if ($scope.zone.value == '$URL' || $scope.zone.value == '$URL_X') {
        $scope.urlFltr = $scope.urls[0];
        $scope.dsblurl = true;
        $scope.urlContent = '';
      }
      if ($scope.zone.value == 'all' || $scope.zone.value == 'BODY' || $scope.zone.value == 'HEADERS' || $scope.zone.value == 'ARGS' || $scope.zone.value == 'FILE_EXT') {
        $scope.dsblzone = true;
        $scope.zoneContent = '';
      } else {
        $scope.dsblzone = false;
      }
    };
    $scope.loadRules = function ($query) {
      return $http.get('/api/settings', { cache: true }).then(function (response) {
        var rules = response.data.whitelistRules.filter(function (ruules) {
            return ruules.id.indexOf($query) != -1;
          });
        return rules;
      });
    };
    //watch changes in inputs and reflect them in main input
    $scope.$watch('[urlFltr,zone,urlContent,zoneContent,chkName,ids]', function () {
      $scope.current = buildStrIds($scope.ids) + buildStrMz($scope.urlFltr, $scope.urlContent, $scope.zone, $scope.zoneContent, $scope.chkName) + ';';
    }, true);
    //useful functions
    var buildStrIds = function (ids) {
      if (ids.length != 0) {
        var str = 'BasicRule wl:';
        ids.forEach(function (elt, ix, arr) {
          str += elt.id + ',';
        });
        return str.substring(0, str.lastIndexOf(','));
      } else
        return '';
    };
    var buildStrMz = function (fltr, fltrc, zone, zonec, nm) {
      var str = '';
      if (fltr['value'] != 'all' && zone['value'] != '$URL' && zone['value'] != '$URL_X') {
        str = ' "mz:' + fltr['value'] + (fltrc != undefined && fltrc != '' ? ':' + fltrc : '');
      } else if (fltr['value'] == 'all' && zone['value'] != '$URL' && zone['value'] != '$URL_X') {
        str = ' "mz:';
      } else {
        str = ' "mz:URL|';
      }
      if (zone['value'] != 'all' && zone['value'] != '$URL' && zone['value'] != '$URL_X' && fltr['value'] != 'all') {
        str += '|' + zone['value'] + (zonec != undefined && zonec != '' ? ':' + zonec : '');
      } else if (zone['value'] != 'all' && fltr['value'] == 'all') {
        str += zone['value'] + (zonec != undefined && zonec != '' ? ':' + zonec : '');
      } else {
        str = '';
      }
      if (nm) {
        str += '|NAME';
      }
      return str != '' ? str += '"' : str;
    };
    //rules highlighter options
    $scope.option = {
      words: [
        {
          color: '#37F230',
          words: ['^BasicRule wl:[0-9]{1,4}(,[0-9]{1,4})*\\s*("mz:(\\$?URL(_X)?(:[^|;]*)?)?(\\|?\\$?(ARGS|ARGS_VAR:[^|;]*|ARGS_VAR_X:[^|;]*|HEADERS|HEADERS_VAR:[^|;]*|HEADERS_VAR_X:[^|;]|BODY|BODY_VAR:[^|;]*|BODY_VAR_X:[^|;]|URL|URL:[^|;]*|URL_X:[^|;]*)(\\|NAME)?)?")?;$']
        },
        {
          color: '#FF534F',
          words: ['^.*$']
        }
      ]
    };
  }
]);
'use strict';
var myApp = angular.module('mgcrea.WafApp');
myApp.controller('UpdateCntrl', [
  '$scope',
  'Backups',
  'Update',
  '$timeout',
  function ($scope, Backups, Update, $timeout) {
    Backups.query(function (data) {
      $scope.ops = data;
    });
    var refresh = function () {
      Backups.query(function (data) {
        $scope.ops = data;
      });
    };
    $scope.update = function () {
      Update.get();
      $timeout(function () {
        refresh();
      }, 200);
    };
    $scope.toDate = function (ts) {
      return new Date(ts).toLocaleString();
    };
  }
]);
'use strict';
//settings controller
myApp.controller('SettingsController', [
  '$scope',
  function ($scope) {
    $scope.options = {
      nginxConfDir: '/etc/nginx/',
      sitesEnabledDir: '/etc/nginx/sites-enabled/',
      naxsiConfDir: '/etc/nginx/naxsi/naxsi_config/',
      haproxyConfDir: '/etc/haproxy/',
      siteCertDir: '/etc/nginx/certificate/',
      whitelistRules: [
        {
          'desc': 'weird request, unable to parse',
          'id': '1'
        },
        {
          'desc': 'request too big, stored on disk and not parsed',
          'id': '2'
        },
        {
          'desc': 'invalid hex encoding, null bytes',
          'id': '10'
        },
        {
          'desc': 'unknown content-type',
          'id': '11'
        },
        {
          'desc': 'invalid formatted url',
          'id': '12'
        },
        {
          'desc': 'invalid POST format',
          'id': '13'
        },
        {
          'desc': 'invalid POST boundary',
          'id': '14'
        },
        {
          'desc': 'sql keywords',
          'id': '1000'
        },
        {
          'desc': 'double quote',
          'id': '1001'
        },
        {
          'desc': '0x, possible hex encoding',
          'id': '1002'
        },
        {
          'desc': 'mysql comment (/*)',
          'id': '1003'
        },
        {
          'desc': 'mysql comment (*/)',
          'id': '1004'
        },
        {
          'desc': 'mysql keyword (|)',
          'id': '1005'
        },
        {
          'desc': 'mysql keyword (&&)',
          'id': '1006'
        },
        {
          'desc': 'mysql comment (--)',
          'id': '1007'
        },
        {
          'desc': 'semicolon',
          'id': '1008'
        },
        {
          'desc': 'equal in var, probable sql/xss',
          'id': '1009'
        },
        {
          'desc': 'parenthesis, probable sql/xss',
          'id': '1010'
        },
        {
          'desc': 'parenthesis, probable sql/xss',
          'id': '1011'
        },
        {
          'desc': 'simple quote',
          'id': '1013'
        },
        {
          'desc': 'comma',
          'id': '1015'
        },
        {
          'desc': 'mysql comment (#)',
          'id': '1016'
        },
        {
          'desc': 'http:// in var',
          'id': '1100'
        },
        {
          'desc': 'https:// in var',
          'id': '1101'
        },
        {
          'desc': 'ftp:// in var',
          'id': '1102'
        },
        {
          'desc': 'php:// in var',
          'id': '1103'
        },
        {
          'desc': 'sftp:// in var',
          'id': '1104'
        },
        {
          'desc': 'zlib:// in var',
          'id': '1105'
        },
        {
          'desc': 'data:// in var',
          'id': '1106'
        },
        {
          'desc': 'glob:// in var',
          'id': '1107'
        },
        {
          'desc': 'phar:// in var',
          'id': '1108'
        },
        {
          'desc': 'file:// in var',
          'id': '1109'
        },
        {
          'desc': 'double dot',
          'id': '1200'
        },
        {
          'desc': 'obvious probe',
          'id': '1202'
        },
        {
          'desc': 'obvious windows path',
          'id': '1203'
        },
        {
          'desc': 'obvious probe',
          'id': '1204'
        },
        {
          'desc': 'backslash',
          'id': '1205'
        },
        {
          'desc': 'html open tag',
          'id': '1302'
        },
        {
          'desc': 'html close tag',
          'id': '1303'
        },
        {
          'desc': '[, possible js',
          'id': '1310'
        },
        {
          'desc': '], possible js',
          'id': '1311'
        },
        {
          'desc': '~ character',
          'id': '1312'
        },
        {
          'desc': 'grave accent !',
          'id': '1314'
        },
        {
          'desc': 'double encoding !',
          'id': '1315'
        },
        {
          'desc': 'utf7/8 encoding',
          'id': '1400'
        },
        {
          'desc': 'M$ encoding',
          'id': '1401'
        },
        {
          'desc': 'Content is neither mulipart/x-www-form..',
          'id': '1402'
        },
        {
          'desc': 'asp/php file upload!',
          'id': '1500'
        }
      ]
    };
    $scope.editorEnabled = {
      nginxConfDir: false,
      sitesEnabledDir: false,
      naxsiConfDir: false,
      haproxyConfDir: false,
      siteCertDir: false,
      whitelistRules: false
    };
    $scope.editable = {
      nginxConfDir: '',
      sitesEnabledDir: '',
      naxsiConfDir: '',
      haproxyConfDir: '',
      siteCertDir: '',
      whitelistRules: []
    };
    $scope.enableEditor = function (elm) {
      $scope.editorEnabled[elm] = true;
      $scope.editable[elm] = $scope.options[elm];
    };
    $scope.disableEditor = function (elm) {
      $scope.editorEnabled[elm] = false;
    };
    $scope.save = function (elm) {
      $scope.options[elm] = $scope.editable[elm];
      $scope.disableEditor(elm);
    };
    $scope.removeWL = function (ix) {
      $scope.options['whitelistRules'].splice(ix, 1);
    };
    $scope.savewl = function () {
      if ($scope.options['whitelistRules'].indexOf($scope.reg) === -1)
        $scope.options['whitelistRules'].push(angular.copy($scope.reg));
    };
  }
]);
/**
 * Created by laassiri on 17/04/15.
 */
'use strict';
//rest api services
myApp.factory('Site', [
  '$resource',
  function ($resource) {
    return $resource('/api/site/:domain');
  }
]).factory('Status', [
  '$resource',
  function ($resource) {
    return $resource('/api/terminal', { cmd: '@cmd' }, {
      query: {
        method: 'GET',
        isArray: false
      }
    });
  }
]).factory('Error', [
  '$resource',
  function ($resource) {
    return $resource('/api/logs/error', {
      from: '@from',
      to: '@to'
    });
  }
]).factory('Access', [
  '$resource',
  function ($resource) {
    return $resource('/api/logs/access', {
      from: '@from',
      to: '@to'
    });
  }
]).factory('Update', [
  '$resource',
  function ($resource) {
    return $resource('/api/update');
  }
]).factory('Backups', [
  '$resource',
  function ($resource) {
    return $resource('/api/backups');
  }
]).factory('Settings', [
  '$resource',
  function ($resource) {
    return $resource('/api/settings');
  }
]);